name: Test JMeter Action

on:
  push:
    branches:
      - develop
  pull_request:
    types: [opened, synchronize, edited, reopened]

jobs:
  action_build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Run JMeter Action on a test
        uses: rbhadti94/apache-jmeter-action@v0.6.0
        with:
          testFilePath: jmeter/plan.jmx
          outputReportsFolder: reports/
          args: "--loglevel INFO"
      # ここはS3になる
      - uses: actions/upload-artifact@v3
        with:
          name: result
          path: reports/
      # - name: 'ls'
      #  run: ls -lhaR ${{steps.download.outputs.download-path}}
      - name: Comment JMeter Action results
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: JMeter Action Results
          message: |
            JMeterを実行しました
      # - name: change owner of vender directory(some files owner is root)
      #  run: sudo chown -R runner:docker ./reports
      - name: 'cat json'
        run: cat ./reports/statistics.json
      - name: Set json content to context
        id: json_parse
        run: |
          content=`cat ./reports/statistics.json`
          content="${content//'%'/'%25'}"
          content="${content//$'\n'/' '}"
          content="${content//$'\r'/' '}"
          content="${content//'HTTP R'/'HTTPR'}"
          echo "statistics=$content" >> $GITHUB_OUTPUT
          echo "${{fromJson($content).Total}}"
